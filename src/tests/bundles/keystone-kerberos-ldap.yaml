series: bionic
variables:
  openstack-origin: &openstack-origin distro
applications:
  keystone:
    charm:  ./keystone
    num_units: 1
    options:
      openstack-origin: *openstack-origin
      preferred-api-version: 3
      token-provider: 'fernet'
      token-expiration: 3600
  keystone-ldap:
    charm:  cs:keystone-ldap
    num_units: 0
    options:
      use-internal-endpoints: true
      ldap-server: 'ldap://freeipa.project.serverstack'
      ldap-user: "uid=admin,cn=users,cn=accounts,dc=project,dc=serverstack"
      ldap-password: "password123"
      ldap-suffix: "cn=users,cn=accounts,dc=project,dc=serverstack"
      ldap-readonly: true
      domain-name: "k8s"
      ldap-config-flags: "{user_tree_dn: 'cn=users,cn=accounts,dc=project,dc=serverstack', user_objectclass: person, user_name_attribute: uid, user_allow_create: False,  user_allow_delete: False}"

  keystone-kerberos:
    charm: ../../../keystone-kerberos
    num_units: 0
    options:
      kerberos-realm: "PROJECT.SERVERSTACK"
      kerberos-server: "freeipa.project.serverstack"
      kerberos-domain: "k8s"
    resources:
      keystone_keytab: "/home/ubuntu/keystone.keytab"
  openstack-dashboard:
    charm: cs:openstack-dashboard
    num_units: 1
    expose: true
    options:
      openstack-origin: *openstack-origin
      webroot: "/"
  mysql:
    charm: cs:percona-cluster
    num_units: 1
    options:
      innodb-buffer-pool-size: 256M
      max-connections: 1000
relations:
- - keystone:shared-db
  - mysql:shared-db
- - openstack-dashboard:identity-service
  - keystone:identity-service
- - openstack-dashboard:shared-db
  - mysql:shared-db
- - keystone
  - keystone-kerberos
- - keystone
  - keystone-ldap
